<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="/img/apple-touch-icon.png"><link rel="icon" type="image/png" href="/img/favicon.png"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,shrink-to-fit=no"><meta name="google-site-verification" content="oprUqqDJlRg_9HlLww6fhOR3mjFIc2ZJUf-eIvfHFEQ"><meta name="baidu-site-verification" content="1ePw1O0rqd"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="theme-color" content="#2f4154"><meta name="description" content=""><meta name="author" content="John Doe"><meta name="keywords" content=""><title>Style - seineo&#39;s blog</title><link rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.staticfile.org/github-markdown-css/4.0.0/github-markdown.min.css"><link rel="stylesheet" href="https://cdn.staticfile.org/highlight.js/10.0.0/styles/github-gist.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_fmb4a04yx8h.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_pjno9b9zyxs.css"><link rel="stylesheet" href="/css/main.css"><meta name="generator" content="Hexo 4.2.1"></head><body><header style="height:70vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/">&nbsp;<strong>seineo's blog</strong>&nbsp;</a> <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/"><i class="iconfont icon-home-fill"></i> 首页</a></li><li class="nav-item"><a class="nav-link" href="/archives/"><i class="iconfont icon-archive-fill"></i> 归档</a></li><li class="nav-item"><a class="nav-link" href="/categories/"><i class="iconfont icon-category-fill"></i> 分类</a></li><li class="nav-item"><a class="nav-link" href="/tags/"><i class="iconfont icon-tags-fill"></i> 标签</a></li><li class="nav-item"><a class="nav-link" href="/about/"><i class="iconfont icon-user-fill"></i> 关于</a></li><li class="nav-item" id="search-btn"><a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;&nbsp;<i class="iconfont icon-search"></i>&nbsp;&nbsp;</a></li></ul></div></div></nav><div class="view intro-2" id="background" parallax="true" style="background:url(/img/post_bg.jpg) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="container text-center white-text fadeInUp"><span class="h2" id="subtitle"></span><div class="mt-3 post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2020-06-03 14:15">2020年6月3日 下午</time></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 2.1k 字 </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 24 分钟</span></div></div></div></div></div></header><main><div class="container-fluid"><div class="row"><div class="d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-md"><div class="container nopadding-md" id="board-ctn"><div class="py-5" id="board"><div class="post-content mx-auto" id="post"><article class="markdown-body"><h1 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h1><p>本文是《The Practice of Programming》一书中Chapter 1: Style的笔记。</p><p>代码风格是十分重要的，一个好的代码风格可以帮助读者更好地理解代码，也能帮助自己在写程序时及时排错。</p><p>本章系统地讨论了代码风格，包括命名、语句、宏、幻数和注释等，但本文仅讨论章节中部分有趣的内容。</p><h1 id="Names"><a href="#Names" class="headerlink" title="Names"></a>Names</h1><blockquote><p>Use descriptive names for globals, short names for locals.</p></blockquote><p>学习第一门程序语言时，我们总被教导道：要使用足够长的变量命名，这样读者才好理解这个变量的用途。其实这样是不对的。</p><p>全局变量的名字是需要足够长、足够具体的，因为他们可能出现在程序的各个地方，这样的名字可以帮助作者和读者回想起这个变量的用途。而局部变量简短些即可，比如要表示学生的人数，<code>n</code>也许就够了，<code>n_stu</code>也不错，但是<code>number_of_stu</code>就没必要，会显得代码冗长。</p><blockquote><p>Use active names for functions.</p></blockquote><p>函数名应该是动态的。比如要打印数组，<code>print_arr</code>就很好，而单独一个<code>arr</code>就让人不知道该函数的用途。名字中的动词也需要足够直白，比如返回布尔值的函数，<code>check_even</code>是模棱两可的，因为它并没有说明如果是偶数返回真还是假，而<code>is_even</code>就让人清楚地知道如果是偶数，该函数返回真。</p><h1 id="Expressions-and-Statements"><a href="#Expressions-and-Statements" class="headerlink" title="Expressions and Statements"></a>Expressions and Statements</h1><blockquote><p>Parenthesize to reslove ambiguity.</p></blockquote><p>括号可以清晰的划分结构与优先级，即使不需要的时候我们也可以加上以避免不必要的错误和增加可读性。</p><p>比如<code>if (x&amp;MASK == BITS)</code>，显然其本意是想判断<code>x</code>和掩码进行与运算后是否等于<code>BITS</code>，但由于位操作符的优先级低于等于号，这段代码实际上等价于<code>if (x &amp; (MASK == BITS))</code>，这也就发生了意料之外的错误，因此这个表达式需要加上括号，即<code>if ((x&amp;MASK) == BITS)</code>。</p><p>又如这样一个表达式：</p><pre><code class="hljs c">leap_year = y % <span class="hljs-number">4</span> == <span class="hljs-number">0</span> &amp;&amp; y % <span class="hljs-number">100</span> != || y % <span class="hljs-number">400</span> == <span class="hljs-number">0</span>;</code></pre><p>这当然是没错的，但第一眼看去，我们难以把握结构，若按如下修改会清晰得多：</p><pre><code class="hljs c">leap_year = ((y%<span class="hljs-number">4</span> == <span class="hljs-number">0</span>) &amp;&amp; (y%<span class="hljs-number">100</span> != <span class="hljs-number">0</span>) || (y%<span class="hljs-number">400</span> == <span class="hljs-number">0</span>));</code></pre><p>注意到，我们移去了一些空格，使高优先级的操作符更紧凑，这样可以帮助读者更快地把握结构。</p><blockquote><p>Be careful with side effects.</p></blockquote><p>不了解序列点(sequence point)、副作用(side effect)和未定义行为(undefined behavior)的朋友可先参见：<a href="https://stackoverflow.com/questions/4176328/undefined-behavior-and-sequence-points" target="_blank" rel="noopener">Undefined behavior and sequence points</a></p><p>在C和C++中，一个序列点前副作用的执行顺序是未定义的。如：</p><pre><code class="hljs c">str[i++] = str[i++] = <span class="hljs-string">' '</span>;</code></pre><p>在这里，<code>;</code>就是一个序列点，而我们知道，<code>++</code>操作符是有副作用的，它不仅返回一个值，还会修改该变量的值。那么当一个语句中对同一个变量做多次<code>++</code>操作会导致未定义行为，因为虽然我们心里想的是<code>i</code>增加两次，但编译器不知道到底<code>i</code>是增加一次还是两次，也不知道是将右边的<code>i</code>递增后的值还是原来的值赋给左边的<code>i</code>，这就导致了<code>warning: multiple unsequenced modification to i</code>。</p><p>再看一个我从书本Exercise 1-5改编的例子，以下代码片段有什么问题呢？</p><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">read</span><span class="hljs-params">(<span class="hljs-keyword">int</span> *ip)</span> </span>&#123;
    <span class="hljs-built_in">scanf</span>(<span class="hljs-string">"%d"</span>, ip);
    <span class="hljs-keyword">return</span> *ip;
&#125;

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">print</span><span class="hljs-params">(<span class="hljs-keyword">int</span> a, <span class="hljs-keyword">int</span> b)</span> </span>&#123; <span class="hljs-built_in">printf</span>(<span class="hljs-string">"%d %d\n"</span>, a, b); &#125;

<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>&#123;
    <span class="hljs-keyword">int</span> a, b;
    <span class="hljs-built_in">print</span>(<span class="hljs-built_in">read</span>(&amp;a), <span class="hljs-built_in">read</span>(&amp;b));
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
&#125;</code></pre><p>我们可以先看看当输入为<code>2 3</code>时，不同编译器下的输出结果：</p><table><thead><tr><th align="left">编译器</th><th align="left">输出结果</th></tr></thead><tbody><tr><td align="left">gcc</td><td align="left">3 2</td></tr><tr><td align="left">clang</td><td align="left">2 3</td></tr></tbody></table><p><code>scanf</code>函数不是分别运行的吗？为什么会产生这样的奇怪的结果呢？原因是<em>函数调用计算完所有参数后且执行被调用函数前</em>也是一个序列点，而我们这里的函数参数计算里含有I/O操作，I/O操作也有副作用，所以这里函数参数的计算顺序也是未定义的，因此如果先计算第一个参数，那么<code>2</code>就会被写入参数<code>a</code>中，<code>3</code>就会被写入<code>b</code>中，输出结果同clang；但如果先计算第二个参数，<code>2</code>和<code>3</code>就会被分别写入<code>b</code>和<code>a</code>中，输出结果同gcc。</p><h1 id="Consistency-and-Idioms"><a href="#Consistency-and-Idioms" class="headerlink" title="Consistency and Idioms"></a>Consistency and Idioms</h1><p>在这一节中，基本都是熟知的准则，不再赘述。但下面这个代码示例告诉了我们一种优雅处理嵌套的<code>if else</code>错误判断语句的方式。</p><p>我们很可能写出类似这样的代码：</p><pre><code class="hljs c"><span class="hljs-keyword">if</span> (argc == <span class="hljs-number">3</span>) 
    <span class="hljs-keyword">if</span> ((fin = fopen(argv[<span class="hljs-number">1</span>], <span class="hljs-string">"r"</span>)) != <span class="hljs-literal">NULL</span>)
        <span class="hljs-keyword">if</span> ((fout = fopen(argv[<span class="hljs-number">2</span>], <span class="hljs-string">"w"</span>)) != <span class="hljs-literal">NULL</span>) &#123;
            <span class="hljs-keyword">while</span> ((c = getc(fin)) != EOF)
                putc(c,fout);
            fclose(fin);
            fclose(fout);
        &#125; <span class="hljs-keyword">else</span>
            <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Can't open input file %s\n"</span>, argv[<span class="hljs-number">2</span>]);
    <span class="hljs-keyword">else</span>
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Can't open input file %s\n"</span>, argv[<span class="hljs-number">1</span>]);
<span class="hljs-keyword">else</span>
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Usage: cp inputfile outputfile\n"</span>);</code></pre><p>使用递进的<code>if</code>判断，最终是前期准备无错误的处理代码，然后再用多个<code>else</code>分别处理各种错误情况。这段代码并不优雅，并且有资源泄露的可能——如果<code>fout</code>打开文件失败，那么<code>fin</code>打开的文件就不会显式关闭，未显式关闭文件可能导致的问题可参见：<a href="https://www.quora.com/Why-do-we-need-to-close-files-in-programming-after-performing-a-read-or-write-operation" target="_blank" rel="noopener">Why do we need to close files?</a><br>那么如何改进呢？我们可以使用<code>if, else if</code>来推进，先处理错误情况，最终才是正常情况下的代码。</p><pre><code class="hljs c"><span class="hljs-keyword">if</span> (argc != <span class="hljs-number">3</span>)
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Usage: cp inputfile outputfile\n"</span>);
<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ((fin = fopen(argv[<span class="hljs-number">1</span>], <span class="hljs-string">"r"</span>)) != <span class="hljs-literal">NULL</span>)
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Can't open input file %s\n"</span>, argv[<span class="hljs-number">1</span>]);
<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ((fout = fopen(argv[<span class="hljs-number">2</span>], <span class="hljs-string">"w"</span>)) != <span class="hljs-literal">NULL</span>) &#123;
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Can't open input file %s\n"</span>, argv[<span class="hljs-number">2</span>]);
    fclose(fin); <span class="hljs-comment">/* release the resource fin occupied */</span>
&#125; <span class="hljs-keyword">else</span> &#123;
    <span class="hljs-keyword">while</span> ((c = getc(fin)) != EOF)
        putc(c,fout);
    fclose(fin);
    fclose(fout);
&#125;</code></pre><h1 id="Function-Macros"><a href="#Function-Macros" class="headerlink" title="Function Macros"></a>Function Macros</h1><blockquote><p>Avoid function macros.</p></blockquote><p>宏是进行文本的替换，因此如果函数宏定义中参数出现了多次，那么它就会被计算多次，这在大多数时候都不是我们想要的。如：</p><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> isupper(c) ((c) &gt;= <span class="hljs-meta-string">'A'</span> &amp;&amp; (c) &lt;= <span class="hljs-meta-string">'Z'</span>)</span>
...
<span class="hljs-keyword">if</span> (<span class="hljs-built_in">isupper</span>(c = getchar()))
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"%c is uppercase\n"</span>, c);</code></pre><p>那么实际<code>if</code>的判断语句等价于</p><pre><code class="hljs c"><span class="hljs-keyword">if</span> (((c = getchar()) &gt;= <span class="hljs-string">'A'</span> &amp;&amp; (c = getchar()) &lt;= <span class="hljs-string">'Z'</span>))</code></pre><p>这显然是错误的，假定我们输入一个字符然后回车，那么只要这个字符的ASCII码值大于等于A的码值就会有输出，因为逻辑与表达式的第二部分程序又读了一个字符，这个字符就是留在缓冲区的<code>\n</code>字符，其ASCII码值为<code>0xa</code>，小于<code>Z</code>的码值。</p><p>很多人习惯使用宏来管理幻数/魔数(Magic Numbers)，其实尽量不要用C预处理器来做这件事，让语言本身来处理是更好的。在C++中可以用<code>const</code>来声明常量：</p><pre><code class="hljs cpp"><span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span> ARR_SIZE = <span class="hljs-number">5</span>;</code></pre><p>C中当然也有<code>const</code>，值得注意的是，用<code>const</code>修饰的值是无法作为<code>静态数组</code>的边界的（因为这是<code>运行时常量</code>），但<code>enum</code>可以实现这一点：</p><pre><code class="hljs c"><span class="hljs-keyword">enum</span> &#123;ARR_SIZE = <span class="hljs-number">5</span>&#125;;</code></pre><p>那这是不是意味着我们永远不能使用宏呢？并不是，我们应该让宏做函数做不了的事情。典型的例子就是仅由声明计算数组的长度：</p><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> NELEMS(array) (sizeof(array) / sizeof(array[0]))</span></code></pre><p>在这里，<code>sizeof(array)</code>计算的就是数组本身的长度，而在函数中，数组参数退化为指针，<code>sizeof(array)</code>就只能计算出指针的大小了。对数组和指针关系不太明确的朋友可参考：<a href="https://stackoverflow.com/questions/1641957/is-an-array-name-a-pointer" target="_blank" rel="noopener">is an array name a pointer?</a></p><h1 id="Comments"><a href="#Comments" class="headerlink" title="Comments"></a>Comments</h1><blockquote><p>Comment functions and global data.</p></blockquote><p>给每个函数和全局变量写适当的注释是一个好习惯。在我接触的好的代码风格中，也有的还在文件开头写一个文件的注释，告诉读者这一个文件的主要用途以及注意事项等，个人认为这也值得学习。</p><blockquote><p>Don’t comment bad code, rewrite it.</p></blockquote><p>这一准则给出了一个有意思的判断，即当注释的字数多过于要注释的代码段时，这段代码可能就是<code>bad code</code>。这时应该看看是否需要改善代码而不是坚持注释。</p><p>至此，第一章就结束了，希望我们都能形成一个好的代码风格。</p></article><hr><div><div class="post-metas mb-3"><div class="post-meta mr-3"><i class="iconfont icon-category"></i> <a class="hover-with-bg" href="/categories/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/">读书笔记</a> <a class="hover-with-bg" href="/categories/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/The-Practice-of-Programming/">The Practice of Programming</a></div><div class="post-meta"><i class="iconfont icon-tags"></i> <a class="hover-with-bg" href="/tags/%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1/">程序设计</a></div></div><p class="note note-warning">本博客所有文章除特别声明外，均采用 <a href="https://zh.wikipedia.org/wiki/Wikipedia:CC_BY-SA_3.0%E5%8D%8F%E8%AE%AE%E6%96%87%E6%9C%AC" target="_blank" rel="nofollow noopener noopener">CC BY-SA 3.0协议</a> 。转载请注明出处！</p><div class="post-prevnext row"><div class="post-prev col-6"></div><div class="post-next col-6"><a href="/int-ch-getchar.html"><span class="hidden-mobile">int ch = getchar()?</span> <span class="visible-mobile">下一篇</span> <i class="iconfont icon-arrowright"></i></a></div></div></div></div></div></div></div><div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p><div id="tocbot"></div></div></div></div></div></main><a id="scroll-top-button" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">搜索</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">关键词</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div><footer class="mt-5"><div class="text-center py-3"><div><a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a></div><div><span id="busuanzi_container_site_pv" style="display:none">总访问量 <span id="busuanzi_value_site_pv"></span> 次 </span><span id="busuanzi_container_site_uv" style="display:none">总访客数 <span id="busuanzi_value_site_uv"></span> 人</span></div></div></footer><script src="https://cdn.staticfile.org/jquery/3.4.1/jquery.min.js"></script><script src="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/js/bootstrap.min.js"></script><script src="/js/main.js"></script><script src="/js/lazyload.js"></script><script src="https://cdn.staticfile.org/tocbot/4.11.1/tocbot.min.js"></script><script>$(document).ready(function(){var t=$("#board-ctn").offset().top;tocbot.init({tocSelector:"#tocbot",contentSelector:".post-content",headingSelector:"h1,h2,h3,h4,h5,h6",linkClass:"tocbot-link",activeLinkClass:"tocbot-active-link",listClass:"tocbot-list",isCollapsedClass:"tocbot-is-collapsed",collapsibleClass:"tocbot-is-collapsible",collapseDepth:0,scrollSmooth:!0,headingsOffset:-t}),0<$(".toc-list-item").length&&$("#toc").css("visibility","visible")})</script><script defer src="https://cdn.staticfile.org/clipboard.js/2.0.6/clipboard.min.js"></script><script src="/js/clipboard-use.js"></script><script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.staticfile.org/typed.js/2.0.11/typed.min.js"></script><script>var typed=new Typed("#subtitle",{strings:["  ","Style&nbsp;"],cursorChar:"_",typeSpeed:70,loop:!1});typed.stop(),$(document).ready(function(){$(".typed-cursor").addClass("h2"),typed.start()})</script><script src="https://cdn.staticfile.org/anchor-js/4.2.2/anchor.min.js"></script><script>anchors.options = {
      placement: "right",
      visible: "hover",
      
    };
    var el = "h1,h2,h3,h4,h5,h6".split(",");
    var res = [];
    for (item of el) {
      res.push(".markdown-body > " + item)
    }
    anchors.add(res.join(", "))</script><script src="/js/local-search.js"></script><script>var path="/local-search.xml",inputArea=document.querySelector("#local-search-input");inputArea.onclick=function(){searchFunc(path,"local-search-input","local-search-result"),this.onclick=null}</script><script src="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.js"></script><link rel="stylesheet" href="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.css"><script>$("#post img:not(.no-zoom img, img[no-zoom]), img[zoom]").each(function(){var t=document.createElement("a");$(t).attr("data-fancybox","images"),$(t).attr("href",$(this).attr("src")),$(this).wrap(t)})</script></body></html>